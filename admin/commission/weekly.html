<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Commission - Lucky Susu Ent Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/admin/admin.css">
    <style>
        .range-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(37, 99, 235, 0.05);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .range-controls label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .range-controls input[type="date"] {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            font-size: 13px;
            font-family: inherit;
        }

        .apply-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .apply-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .commission-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .commission-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            letter-spacing: 0.7px;
            background: rgba(59, 130, 246, 0.04);
        }

        .commission-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.7);
            font-size: 13px;
        }

        .transactions-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="admin-sidebar-title">Lucky Susu Ent Admin</div>
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item">
                    <a href="/admin/dashboard.html" class="sidebar-menu-button" style="text-decoration: none; color: inherit;">
                        <span style="font-size: 16px; display: inline-block;">‚Üê</span>
                        <span>Back to Dashboard</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="admin-main">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Weekly Commission</h1>
                    <p class="page-subtitle">
                        Track total commissions generated from withdrawals for each agent within a custom week range.
                    </p>
                </div>
                <div class="range-controls">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <button class="apply-btn" id="applyRange">Apply Range</button>
                </div>
            </div>

            <div class="summary-card" id="summaryCard" style="display:none;">
                <div class="summary-label">Total Commission</div>
                <div class="summary-value" id="totalCommission">‚Çµ0.00</div>
                <div class="summary-date" id="summaryRange">--</div>
            </div>

            <div id="commissionTableContainer" class="transactions-container">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Loading commission data...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function() {
            function checkAdminAuth() {
                const userData = localStorage.getItem('user');
                if (!userData) {
                    redirectToLogin();
                    return false;
                }
                try {
                    const user = JSON.parse(userData);
                    if (!user.token) {
                        redirectToLogin();
                        return false;
                    }
                    return true;
                } catch (e) {
                    console.error('Auth check error:', e);
                    redirectToLogin();
                    return false;
                }
            }

            function redirectToLogin() {
                localStorage.removeItem('user');
                window.location.href = '/index.html';
            }

            if (!checkAdminAuth()) {
                if (document.body) {
                    document.body.style.display = 'none';
                }
                document.write('<div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;"><h2>Please login to access admin dashboard</h2><p>Redirecting...</p></div>');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    if (!checkAdminAuth()) {
                        document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;"><h2>Please login to access admin dashboard</h2><p>Redirecting...</p></div>';
                    }
                });
            }
        })();
    </script>
    <script src="/api-client.js"></script>
    <script>
        const summaryCard = document.getElementById('summaryCard');
        const totalCommissionEl = document.getElementById('totalCommission');
        const summaryRangeEl = document.getElementById('summaryRange');
        const tableContainer = document.getElementById('commissionTableContainer');
        const startInput = document.getElementById('startDate');
        const endInput = document.getElementById('endDate');
        const applyBtn = document.getElementById('applyRange');

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GH', {
                style: 'currency',
                currency: 'GHS',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0);
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, (char) => {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return map[char] || char;
            });
        }

        function getDefaultWeekRange() {
            const today = new Date();
            const day = today.getDay(); // 0 (Sun) - 6 (Sat)
            const diffToMonday = day === 0 ? -6 : 1 - day;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            const toISO = (d) => d.toISOString().split('T')[0];
            return { start: toISO(monday), end: toISO(sunday) };
        }

        async function loadWeeklyCommission(startDate, endDate, showLoading = true) {
            if (!startDate || !endDate) {
                return;
            }

            if (showLoading) {
                tableContainer.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>Loading commission data...</div>
                    </div>
                `;
            }

            try {
                if (typeof AdminAPI === 'undefined') {
                    throw new Error('Admin API not loaded. Please refresh the page.');
                }

                const response = await AdminAPI.getWeeklyCommission(startDate, endDate);
                if (!response || !response.success) {
                    throw new Error(response?.error || 'Failed to load commission data');
                }

                const data = response.data || {};
                const agents = data.agents || [];
                const totalAmount = data.overall_total || 0;

                totalCommissionEl.textContent = formatCurrency(totalAmount);
                summaryRangeEl.textContent = `${formatDateDisplay(startDate)} ‚Üí ${formatDateDisplay(endDate)}`;
                summaryCard.style.display = 'block';

                if (agents.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-title">No Commissions Recorded</div>
                            <div class="empty-state-text">No commission deductions were recorded between ${formatDateDisplay(startDate)} and ${formatDateDisplay(endDate)}.</div>
                        </div>
                    `;
                    return;
                }

                let tableHTML = `
                    <table class="commission-table">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Total Commission</th>
                                <th>Clients Impacted</th>
                                <th>Commission Entries</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                agents.forEach((agent) => {
                    tableHTML += `
                        <tr>
                            <td>
                                <div style="font-weight:700;">${escapeHtml(agent.agent_name || 'Unknown')}</div>
                                <div style="font-size:12px; color:var(--text-secondary);">ID: ${agent.agent_id}</div>
                            </td>
                            <td>${formatCurrency(agent.total_commission || 0)}</td>
                            <td>${agent.unique_clients || 0}</td>
                            <td>${agent.commission_count || 0}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                tableContainer.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading weekly commission:', error);
                tableContainer.innerHTML = `
                    <div class="error-state">
                        <div class="error-state-icon">‚ö†Ô∏è</div>
                        <div class="error-state-title">Error Loading Commission Data</div>
                        <div class="error-state-text">${escapeHtml(error?.message || 'Please try again later.')}</div>
                    </div>
                `;
            }
        }

        function validateAndLoad() {
            const startDate = startInput.value;
            const endDate = endInput.value;
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date.');
                return;
            }
            loadWeeklyCommission(startDate, endDate);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const { start, end } = getDefaultWeekRange();
            startInput.value = start;
            endInput.value = end;
            loadWeeklyCommission(start, end);

            applyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                validateAndLoad();
            });

            startInput.addEventListener('change', () => {
                if (endInput.value) {
                    validateAndLoad();
                }
            });

            endInput.addEventListener('change', () => {
                if (startInput.value) {
                    validateAndLoad();
                }
            });
        });
    </script>
</body>
</html>

